<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audio | Kozi przybornik</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: radial-gradient(circle at 20% 20%, rgba(0, 255, 128, 0.06), transparent 25%),
             radial-gradient(circle at 80% 0%, rgba(0, 255, 128, 0.08), transparent 35%),
             #031605;
      --panel: #000;
      --panel-alt: #041b08;
      --border: #16c60c;
      --text: #9cf09c;
      --accent: #16c60c;
      --accent-dark: #0d7a07;
      --accent-strong: #1ee616;
      --muted: rgba(156, 240, 156, 0.7);
      --danger: #ff5f5f;
      --glow: 0 0 25px rgba(22, 198, 12, 0.45);
      --radius: 12px;
      --shadow: 0 8px 24px rgba(0, 0, 0, 0.45);
      --font: "Fira Code", "Consolas", "Source Code Pro", monospace;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
    }

    .page {
      max-width: 1280px;
      margin: 0 auto;
      padding: 28px 28px 40px;
      display: flex;
      flex-direction: column;
      gap: 22px;
    }

    header {
      background: var(--panel);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 22px 24px;
      box-shadow: var(--glow);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    header h1 {
      margin: 0;
      font-size: clamp(22px, 3vw, 30px);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    header p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    .status-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 13px;
      color: var(--muted);
    }

    .status-pill {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(22, 198, 12, 0.08);
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      background: var(--panel);
      border: 1px solid rgba(22, 198, 12, 0.7);
      border-radius: var(--radius);
      padding: 12px 16px;
      box-shadow: var(--shadow);
    }

    .toolbar .left,
    .toolbar .right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .search-input {
      background: #031806;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 8px;
      min-width: 220px;
      font-family: var(--font);
    }

    .btn {
      border: 1px solid var(--border);
      background: #031806;
      color: var(--text);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-family: var(--font);
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      transition: all 0.2s ease;
    }

    .btn:hover {
      background: rgba(22, 198, 12, 0.15);
      box-shadow: 0 0 12px rgba(22, 198, 12, 0.25);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-danger {
      border-color: var(--danger);
      color: #ffd6d6;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(280px, 0.7fr);
      gap: 22px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid rgba(22, 198, 12, 0.6);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      min-height: 420px;
    }

    .panel h2 {
      margin: 0 0 14px;
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .samples-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
      gap: 12px;
    }

    .sample-card {
      background: var(--panel-alt);
      border: 1px solid rgba(22, 198, 12, 0.4);
      border-radius: 10px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 150px;
    }

    .sample-title {
      font-size: 14px;
      font-weight: 600;
    }

    .sample-meta {
      font-size: 12px;
      color: var(--muted);
      word-break: break-all;
    }

    .sample-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: auto;
    }

    .sample-actions select {
      background: #031806;
      border: 1px solid rgba(22, 198, 12, 0.6);
      color: var(--text);
      border-radius: 6px;
      padding: 6px 8px;
      font-family: var(--font);
      font-size: 12px;
    }

    .favorites-panel {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .fav-list {
      border: 1px solid rgba(22, 198, 12, 0.5);
      border-radius: 10px;
      padding: 12px;
      background: #031206;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .fav-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .fav-header h3 {
      margin: 0;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .fav-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .fav-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 8px;
      border: 1px dashed rgba(22, 198, 12, 0.4);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.4);
    }

    .fav-item-title {
      font-size: 13px;
      font-weight: 600;
    }

    .fav-item-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .empty-state {
      text-align: center;
      font-size: 13px;
      color: var(--muted);
      padding: 20px 0;
    }

    .legend {
      font-size: 12px;
      color: var(--muted);
    }

    @media (max-width: 980px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>Audio — panel dźwięków</h1>
      <p>Odtwarzanie sampli, zarządzanie listami „Ulubione” oraz synchronizacja przez Firebase.</p>
      <div class="status-bar">
        <span class="status-pill" id="manifestStatus">Manifest: brak danych</span>
        <span class="status-pill" id="firebaseStatus">Firebase: oczekiwanie</span>
        <span class="status-pill" id="favoritesStatus">Ulubione: 0 list</span>
      </div>
    </header>

    <section class="toolbar">
      <div class="left">
        <input class="search-input" id="searchInput" type="search" placeholder="Szukaj sampla..." />
        <button class="btn" id="reloadManifest">Wczytaj manifest</button>
      </div>
      <div class="right">
        <button class="btn" id="addList">Nowa lista ulubionych</button>
        <button class="btn" id="refreshFavorites">Odśwież ulubione</button>
      </div>
    </section>

    <section class="layout">
      <div class="panel">
        <h2>Lista sampli</h2>
        <p class="legend">Źródło danych: AudioManifest.xlsx (kolumny NazwaSampla, NazwaPliku, LinkDoFolderu).</p>
        <div id="samplesGrid" class="samples-grid"></div>
      </div>

      <aside class="panel">
        <h2>Ulubione</h2>
        <div class="favorites-panel" id="favoritesPanel"></div>
      </aside>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="config/firebase-config.js"></script>
  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore,
      doc,
      setDoc,
      onSnapshot,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const manifestStatus = document.getElementById("manifestStatus");
    const firebaseStatus = document.getElementById("firebaseStatus");
    const favoritesStatus = document.getElementById("favoritesStatus");
    const samplesGrid = document.getElementById("samplesGrid");
    const favoritesPanel = document.getElementById("favoritesPanel");
    const searchInput = document.getElementById("searchInput");
    const reloadManifest = document.getElementById("reloadManifest");
    const addListButton = document.getElementById("addList");
    const refreshFavoritesButton = document.getElementById("refreshFavorites");

    const state = {
      items: [],
      itemsById: new Map(),
      favorites: { lists: [] },
      firestore: null,
      favoritesDoc: null,
      usingFirestore: false,
      manifestReady: false
    };

    const audioPlayer = new Audio();

    const DEFAULT_LIST_NAME = "Ulubione";

    const slugify = (value, index) => {
      const base = value
        .toLowerCase()
        .trim()
        .replace(/[^\p{L}\p{N}]+/gu, "-")
        .replace(/^-|-$/g, "");
      return base || `sample-${index}`;
    };

    const normalizeUrl = (folderUrl, filename) => {
      const folder = String(folderUrl || "").trim().replace(/\/+$/, "");
      const file = String(filename || "").trim().replace(/^\/+/, "");
      if (!folder || !file) {
        return "";
      }
      return `${folder}/${file}`;
    };

    const updateStatus = () => {
      manifestStatus.textContent = state.manifestReady
        ? `Manifest: ${state.items.length} pozycji`
        : "Manifest: brak danych";
      firebaseStatus.textContent = state.usingFirestore
        ? "Firebase: połączono"
        : "Firebase: lokalne ustawienia";
      favoritesStatus.textContent = `Ulubione: ${state.favorites.lists.length} list`;
    };

    const saveFavorites = async () => {
      if (state.usingFirestore && state.favoritesDoc) {
        await setDoc(
          state.favoritesDoc,
          {
            ...state.favorites,
            updatedAt: serverTimestamp()
          },
          { merge: true }
        );
        return;
      }
      localStorage.setItem("audio.favorites", JSON.stringify(state.favorites));
    };

    const defaultFavorites = () => ({
      lists: [
        {
          id: crypto.randomUUID(),
          name: DEFAULT_LIST_NAME,
          itemIds: []
        }
      ]
    });

    const normalizeFavorites = (raw) => {
      if (!raw || !Array.isArray(raw.lists)) {
        return defaultFavorites();
      }
      return {
        lists: raw.lists.map((list) => ({
          id: list.id || crypto.randomUUID(),
          name: list.name || DEFAULT_LIST_NAME,
          itemIds: Array.isArray(list.itemIds) ? list.itemIds : []
        }))
      };
    };

    const loadFavoritesLocal = () => {
      const stored = localStorage.getItem("audio.favorites");
      if (!stored) {
        state.favorites = defaultFavorites();
        return;
      }
      try {
        state.favorites = normalizeFavorites(JSON.parse(stored));
      } catch (error) {
        state.favorites = defaultFavorites();
      }
    };

    const initFirebase = () => {
      if (!window.firebaseConfig || !window.firebaseConfig.apiKey) {
        firebaseStatus.textContent = "Firebase: brak konfiguracji";
        loadFavoritesLocal();
        updateStatus();
        return;
      }
      const app = initializeApp(window.firebaseConfig);
      const db = getFirestore(app);
      state.firestore = db;
      state.favoritesDoc = doc(db, "audio", "favorites");
      state.usingFirestore = true;

      onSnapshot(state.favoritesDoc, (snapshot) => {
        if (!snapshot.exists()) {
          state.favorites = defaultFavorites();
          saveFavorites().catch(console.error);
          renderFavorites();
          updateStatus();
          return;
        }
        state.favorites = normalizeFavorites(snapshot.data());
        renderFavorites();
        updateStatus();
      });
    };

    const playSample = (itemId) => {
      const item = state.itemsById.get(itemId);
      if (!item) {
        return;
      }
      if (!item.fullUrl) {
        alert("Brak linku do pliku audio w manifestie.");
        return;
      }
      audioPlayer.src = item.fullUrl;
      audioPlayer.play().catch(() => {
        alert("Nie można odtworzyć dźwięku. Sprawdź link.");
      });
    };

    const renderSamples = () => {
      const filter = searchInput.value.trim().toLowerCase();
      const visibleItems = state.items.filter((item) =>
        item.label.toLowerCase().includes(filter)
      );

      if (!visibleItems.length) {
        samplesGrid.innerHTML = "<div class=\"empty-state\">Brak wyników dla podanego filtra.</div>";
        return;
      }

      const optionsHtml = state.favorites.lists
        .map((list) => `<option value="${list.id}">${list.name}</option>`)
        .join("");

      samplesGrid.innerHTML = visibleItems
        .map(
          (item) => `
            <div class="sample-card" data-id="${item.id}">
              <div class="sample-title">${item.label}</div>
              <div class="sample-meta">${item.filename || "Brak nazwy pliku"}</div>
              <div class="sample-actions">
                <button class="btn" data-action="play">Odtwórz</button>
                <select class="fav-select">
                  ${optionsHtml}
                </select>
                <button class="btn" data-action="add-favorite">Dodaj do listy</button>
              </div>
            </div>
          `
        )
        .join("");
    };

    const renderFavorites = () => {
      if (!state.favorites.lists.length) {
        favoritesPanel.innerHTML = "<div class=\"empty-state\">Brak list ulubionych.</div>";
        return;
      }

      favoritesPanel.innerHTML = state.favorites.lists
        .map(
          (list, index) => `
            <div class="fav-list" data-list-id="${list.id}">
              <div class="fav-header">
                <h3>${list.name}</h3>
                <div class="fav-actions">
                  <button class="btn" data-action="list-up" ${index === 0 ? "disabled" : ""}>▲</button>
                  <button class="btn" data-action="list-down" ${index === state.favorites.lists.length - 1 ? "disabled" : ""}>▼</button>
                  <button class="btn" data-action="list-rename">Zmień nazwę</button>
                  <button class="btn btn-danger" data-action="list-remove">Usuń</button>
                </div>
              </div>
              <div class="fav-items">
                ${
                  list.itemIds.length
                    ? list.itemIds
                        .map((itemId, itemIndex) => {
                          const item = state.itemsById.get(itemId);
                          return `
                            <div class="fav-item" data-item-id="${itemId}">
                              <div class="fav-item-title">${item ? item.label : "(brak w manifeście)"}</div>
                              <div class="fav-item-actions">
                                <button class="btn" data-action="fav-play">Odtwórz</button>
                                <button class="btn" data-action="fav-up" ${itemIndex === 0 ? "disabled" : ""}>▲</button>
                                <button class="btn" data-action="fav-down" ${itemIndex === list.itemIds.length - 1 ? "disabled" : ""}>▼</button>
                                <button class="btn btn-danger" data-action="fav-remove">Usuń</button>
                              </div>
                            </div>
                          `;
                        })
                        .join("")
                    : "<div class=\"empty-state\">Lista jest pusta.</div>"
                }
              </div>
            </div>
          `
        )
        .join("");
      renderSamples();
    };

    const addFavoriteList = async () => {
      const name = prompt("Nazwa nowej listy ulubionych:", "Nowa lista");
      if (!name) {
        return;
      }
      state.favorites.lists.push({
        id: crypto.randomUUID(),
        name: name.trim(),
        itemIds: []
      });
      await saveFavorites();
      renderFavorites();
      updateStatus();
    };

    const addItemToFavorites = async (listId, itemId) => {
      const list = state.favorites.lists.find((entry) => entry.id === listId);
      if (!list) {
        return;
      }
      if (!list.itemIds.includes(itemId)) {
        list.itemIds.push(itemId);
        await saveFavorites();
        renderFavorites();
        updateStatus();
      }
    };

    const moveList = async (listId, direction) => {
      const index = state.favorites.lists.findIndex((entry) => entry.id === listId);
      if (index < 0) {
        return;
      }
      const targetIndex = index + direction;
      if (targetIndex < 0 || targetIndex >= state.favorites.lists.length) {
        return;
      }
      const [removed] = state.favorites.lists.splice(index, 1);
      state.favorites.lists.splice(targetIndex, 0, removed);
      await saveFavorites();
      renderFavorites();
    };

    const renameList = async (listId) => {
      const list = state.favorites.lists.find((entry) => entry.id === listId);
      if (!list) {
        return;
      }
      const name = prompt("Nowa nazwa listy:", list.name);
      if (!name) {
        return;
      }
      list.name = name.trim();
      await saveFavorites();
      renderFavorites();
    };

    const removeList = async (listId) => {
      if (!confirm("Czy na pewno usunąć listę?")) {
        return;
      }
      state.favorites.lists = state.favorites.lists.filter((entry) => entry.id !== listId);
      if (!state.favorites.lists.length) {
        state.favorites = defaultFavorites();
      }
      await saveFavorites();
      renderFavorites();
      updateStatus();
    };

    const moveItem = async (listId, itemId, direction) => {
      const list = state.favorites.lists.find((entry) => entry.id === listId);
      if (!list) {
        return;
      }
      const index = list.itemIds.indexOf(itemId);
      const target = index + direction;
      if (index < 0 || target < 0 || target >= list.itemIds.length) {
        return;
      }
      const [removed] = list.itemIds.splice(index, 1);
      list.itemIds.splice(target, 0, removed);
      await saveFavorites();
      renderFavorites();
    };

    const removeItem = async (listId, itemId) => {
      const list = state.favorites.lists.find((entry) => entry.id === listId);
      if (!list) {
        return;
      }
      list.itemIds = list.itemIds.filter((id) => id !== itemId);
      await saveFavorites();
      renderFavorites();
    };

    const parseManifest = async () => {
      manifestStatus.textContent = "Manifest: wczytywanie...";
      const response = await fetch("AudioManifest.xlsx", { cache: "no-store" });
      if (!response.ok) {
        throw new Error("Nie udało się pobrać manifestu.");
      }
      const data = await response.arrayBuffer();
      const workbook = XLSX.read(data, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

      if (!rows.length) {
        throw new Error("Manifest nie zawiera danych.");
      }

      const items = [];
      const seen = new Set();
      rows.forEach((row, index) => {
        const label = String(row.NazwaSampla || "").trim();
        const filename = String(row.NazwaPliku || "").trim();
        const folderUrl = String(row.LinkDoFolderu || "").trim();
        if (!label) {
          return;
        }
        let id = slugify(label, index + 1);
        if (seen.has(id)) {
          id = `${id}-${index + 1}`;
        }
        seen.add(id);
        const fullUrl = normalizeUrl(folderUrl, filename);
        items.push({ id, label, filename, folderUrl, fullUrl });
      });

      state.items = items.sort((a, b) => a.label.localeCompare(b.label));
      state.itemsById = new Map(state.items.map((item) => [item.id, item]));
      state.manifestReady = true;
      updateStatus();
      renderSamples();
      renderFavorites();
    };

    samplesGrid.addEventListener("click", (event) => {
      const button = event.target.closest("button");
      if (!button) {
        return;
      }
      const card = event.target.closest(".sample-card");
      if (!card) {
        return;
      }
      const itemId = card.dataset.id;
      if (button.dataset.action === "play") {
        playSample(itemId);
      }
      if (button.dataset.action === "add-favorite") {
        const select = card.querySelector(".fav-select");
        addItemToFavorites(select.value, itemId);
      }
    });

    favoritesPanel.addEventListener("click", (event) => {
      const button = event.target.closest("button");
      if (!button) {
        return;
      }
      const listEl = event.target.closest(".fav-list");
      if (!listEl) {
        return;
      }
      const listId = listEl.dataset.listId;
      const itemEl = event.target.closest(".fav-item");
      const itemId = itemEl ? itemEl.dataset.itemId : null;

      switch (button.dataset.action) {
        case "list-up":
          moveList(listId, -1);
          break;
        case "list-down":
          moveList(listId, 1);
          break;
        case "list-rename":
          renameList(listId);
          break;
        case "list-remove":
          removeList(listId);
          break;
        case "fav-play":
          if (itemId) {
            playSample(itemId);
          }
          break;
        case "fav-up":
          if (itemId) {
            moveItem(listId, itemId, -1);
          }
          break;
        case "fav-down":
          if (itemId) {
            moveItem(listId, itemId, 1);
          }
          break;
        case "fav-remove":
          if (itemId) {
            removeItem(listId, itemId);
          }
          break;
        default:
          break;
      }
    });

    searchInput.addEventListener("input", renderSamples);
    reloadManifest.addEventListener("click", () => {
      parseManifest().catch((error) => {
        alert(error.message);
        manifestStatus.textContent = "Manifest: błąd wczytywania";
      });
    });
    addListButton.addEventListener("click", addFavoriteList);
    refreshFavoritesButton.addEventListener("click", () => {
      if (!state.usingFirestore) {
        loadFavoritesLocal();
        renderFavorites();
        updateStatus();
      }
    });

    loadFavoritesLocal();
    renderFavorites();
    initFirebase();
    parseManifest().catch((error) => {
      manifestStatus.textContent = "Manifest: błąd wczytywania";
      console.error(error);
    });
    updateStatus();
  </script>
</body>
</html>
