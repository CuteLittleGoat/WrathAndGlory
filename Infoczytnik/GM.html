<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TEST: Infoczytnik - panel GM</title>
  <script>
    (function autoCacheBust(){
      const INF_VERSION = "2026-02-16_09-30-00"; // <- zmieniaj przy aktualizacjach (data + godzina)
      window.__dsVersion = INF_VERSION;
      const url = new URL(window.location.href);
      if (url.searchParams.get("v") !== INF_VERSION) {
        url.searchParams.set("v", INF_VERSION);
        window.location.replace(url.toString());
      }
    })();
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Cinzel:wght@400;700&family=Rajdhani:wght@400;600&family=Black+Ops+One&family=Staatliches&family=Orbitron:wght@400;700&family=Questrial&family=Russo+One&display=swap" rel="stylesheet">
  <style>
    :root{--text:#eaeaea;--muted:#bdbdbd;--accent:#ffd27a;--border:#2a2a2a;--panel:rgba(18,18,18,.92);}
    *{box-sizing:border-box}
    body{margin:0;padding:18px;font-family:Arial,sans-serif;background:linear-gradient(180deg,#070707,#0f0f0f);color:var(--text);}
    .wrap{max-width:980px;margin:0 auto}
    .language-switcher{display:flex;justify-content:flex-end;margin-bottom:10px;}
    .language-switcher select{
      background:#0f0f0f;
      color:var(--text);
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 12px;
      font-size:14px;
    }
    h1{margin:0 0 10px 0;font-size:20px;color:var(--accent);letter-spacing:.3px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);}
    label{display:block;margin:10px 0 6px 0;color:var(--muted);font-size:13px}
    select,textarea,input[type="number"],input[type="color"],input[type="text"]{
      width:100%;background:#0f0f0f;color:var(--text);border:1px solid var(--border);
      border-radius:10px;padding:10px 12px;font-size:16px;outline:none;
    }
    textarea{min-height:140px;resize:vertical;line-height:1.3}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1;min-width:240px}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      flex:1;min-width:160px;border:none;border-radius:12px;padding:12px 14px;font-size:16px;cursor:pointer;
      background:#1d1d1d;color:var(--text);border:1px solid var(--border);
    }
    button.primary{background:linear-gradient(180deg,#3a2a12,#1c1408);border:1px solid rgba(255,210,122,.35);color:var(--accent);}
    button.warn{background:linear-gradient(180deg,#1c0c0c,#120606);border:1px solid rgba(255,120,120,.25);color:#ffb3b3;}
    .small{margin-top:10px;font-size:12px;color:var(--muted)}
    .status{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border)}
    .preview{
      margin:10px 0 0 0;padding:10px 12px;border-radius:10px;border:1px dashed rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);color:#cfcfcf;font-family:Consolas,"Courier New",monospace;font-size:13px;white-space:pre-wrap;
    }
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.18);cursor:pointer;user-select:none;font-size:13px;color:#eaeaea;}
    .chip span{display:inline-block;width:12px;height:12px;border-radius:3px;margin-right:6px;vertical-align:-2px;border:1px solid rgba(0,0,0,.25)}

    /* ===== Układ: Losowość fillerów (Suffix wyrównany pod Prefix po prawej) ===== */
    .fillerBox{
      padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#0f0f0f;
    }
    .fillerTop{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;
    }
    .fillerTop input[type="checkbox"]{width:18px;height:18px;margin:0}
    .fillerManual{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:end;
    }
    .fillerManual .right{
      justify-self:end;
      width:min(260px, 100%);
    }
    .fillerManual .left{
      width:min(260px, 100%);
    }
    .miniLabel{
      color:#777;
      font-size:12px;
      margin-bottom:6px;
      display:block;
    }
    .pairRow{
      display:flex;gap:10px;align-items:center;justify-content:flex-end;
    }
    .pairRow b{color:#bdbdbd;font-weight:600}
    .pairRow input[type="number"]{width:110px}

    hr.sep{border:none;border-top:1px solid rgba(255,255,255,.08);margin:14px 0;}
    code{font-family:Consolas,"Courier New",monospace;font-size:12px;color:#ddd}

    .livePreviewBox{
      margin-top:12px;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.35);
      min-height:140px;
      display:flex;
      flex-direction:column;
      gap:8px;
      justify-content:center;
    }
    .livePreviewBox .line{display:block;}
    .livePreviewBox .prefix,.livePreviewBox .suffix{opacity:.9;}
    .livePreviewBox .message{line-height:1.35;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="language-switcher">
      <select id="languageSelect" aria-label="Wersja językowa">
        <option value="pl">Polski</option>
        <option value="en">English</option>
      </select>
    </div>
    <h1 id="pageTitle" data-i18n="pageTitle">TEST: Infoczytnik - panel GM</h1>
    <div class="card">

      <div class="row">
        <!-- LEWA KOLUMNA -->
        <div class="col">
          <label data-i18n="labelFaction">Frakcja / layout</label>
          <select id="faction">
            <option value="mechanicus" data-i18n="factionMechanicus">Adeptus Mechanicus</option>
            <option value="inquisition" data-i18n="factionInquisition">Inkwizycja</option>
            <option value="militarum" data-i18n="factionMilitarum">Astra Militarum</option>
            <option value="khorne" data-i18n="factionKhorne">Khorne</option>
            <option value="nurgle" data-i18n="factionNurgle">Nurgle</option>
            <option value="tzeentch" data-i18n="factionTzeentch">Tzeentch</option>
            <option value="slaanesh" data-i18n="factionSlaanesh">Slaanesh</option>
            <option value="chaos_undivided" data-i18n="factionChaosUndivided">Chaos Undivided</option>
          </select>

          <!-- Kolor treści + szybkie -->
          <label data-i18n="labelMessageColor">Kolor fontu (treść wiadomości)</label>
          <input type="color" id="fontColor" value="#00ff66" />
          <div class="chips" id="msgColorChips">
            <div class="chip" data-target="msg" data-color="#00ff66"><span style="background:#00ff66"></span><span data-i18n="colorGreen">Zielony</span></div>
            <div class="chip" data-target="msg" data-color="#ff3333"><span style="background:#ff3333"></span><span data-i18n="colorRed">Czerwony</span></div>
            <div class="chip" data-target="msg" data-color="#d4af37"><span style="background:#d4af37"></span><span data-i18n="colorGold">Złoty</span></div>
            <div class="chip" data-target="msg" data-color="#ffffff"><span style="background:#ffffff"></span><span data-i18n="colorWhite">Biały</span></div>
          </div>

          <!-- Rozmiar treści -->
          <label data-i18n="labelMessageSize">Wielkość fontu (treść wiadomości) — px</label>
          <input type="number" id="msgFontSize" min="12" max="80" step="1" value="20" />

          <hr class="sep">

          <!-- Kolor Prefix+Suffix -->
          <label data-i18n="labelPrefixSuffixColor">Kolor Prefix + Suffix (wspólny)</label>
          <div class="row" style="gap:10px;">
            <div class="col" style="min-width:180px;">
              <input type="text" id="psColorText" value="rgba(255,255,255,.88)" />
              <div class="small" data-i18n="prefixSuffixColorHint">Możesz wpisać np. <code>#ffffff</code> albo <code>rgba(255,255,255,.88)</code></div>
            </div>
            <div class="col" style="min-width:160px;">
              <input type="color" id="psColorPicker" value="#ffffff" />
              <div class="small" data-i18n="prefixSuffixPickerHint">Picker ustawia kolor jako <code>#RRGGBB</code></div>
            </div>
          </div>

          <!-- Szybkie kolory Prefix/Suffix -->
          <div class="chips" id="psColorChips">
            <div class="chip" data-target="ps" data-color="#00ff66"><span style="background:#00ff66"></span><span data-i18n="colorGreen">Zielony</span></div>
            <div class="chip" data-target="ps" data-color="#ff3333"><span style="background:#ff3333"></span><span data-i18n="colorRed">Czerwony</span></div>
            <div class="chip" data-target="ps" data-color="#d4af37"><span style="background:#d4af37"></span><span data-i18n="colorGold">Złoty</span></div>
            <div class="chip" data-target="ps" data-color="#ffffff"><span style="background:#ffffff"></span><span data-i18n="colorWhite">Biały</span></div>
          </div>

          <!-- Rozmiar Prefix/Suffix -->
          <label data-i18n="labelPrefixSuffixSize">Wielkość fontu Prefix + Suffix (wspólna) — px</label>
          <input type="number" id="psFontSize" min="10" max="60" step="1" value="10" />

          <div class="small" data-i18n="logoHint">
            Logo ma stały rozmiar w Infoczytniku. Zmiana rozmiaru prefixu może spowodować zawijanie (OK), logo zostaje bez zmian.
          </div>
        </div>

        <!-- PRAWA KOLUMNA -->
        <div class="col">
          <label data-i18n="labelFillersRandom">Losowość fillerów</label>

          <div class="fillerBox">
            <div class="fillerTop">
              <input type="checkbox" id="randomFillers" checked />
              <span data-i18n="labelRandomAuto">Losuj automatycznie</span>
            </div>

            <div class="fillerManual">
              <div class="left">
                <span class="miniLabel" data-i18n="labelManual">Ręcznie</span>
                <div class="pairRow">
                  <b data-i18n="labelPrefix">Prefix</b>
                  <input type="number" id="prefixIndex" min="1" value="1" />
                </div>
              </div>

              <div class="right">
                <div class="pairRow">
                  <b data-i18n="labelSuffix">Suffix</b>
                  <input type="number" id="suffixIndex" min="1" value="1" />
                </div>
              </div>
            </div>
          </div>

          <div class="small" data-i18n="randomHint">
            Gdy losowanie wyłączone, wybierasz osobno numer Prefix i Suffix (1..N zależnie od frakcji).
          </div>

          <div class="row" style="align-items:center; gap:18px; margin-top:12px;">
            <div style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="showLogo" checked style="width:18px; height:18px; margin:0;" />
              <label for="showLogo" style="margin:0; color:var(--text);" data-i18n="labelShowLogo">Dodaj logo</label>
            </div>
            <div style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="flicker" checked style="width:18px; height:18px; margin:0;" />
              <label for="flicker" style="margin:0; color:var(--text);" data-i18n="labelFlicker">Flicker</label>
            </div>
          </div>

          <div class="livePreviewBox" id="livePreview">
            <span class="line prefix" id="livePreviewPrefix">++ INCOMING DATA FEED ++</span>
            <span class="line message" id="livePreviewMsg">Lorem ipsum dolor sit amet, consectetur adipiscing elit.</span>
            <span class="line suffix" id="livePreviewSuffix">++ PRAISE THE OMNISSIAH ++</span>
          </div>
        </div>
      </div>

      <div class="preview" id="prefixPreview"></div>

      <label data-i18n="labelMessage">Treść komunikatu</label>
      <textarea id="message" placeholder="Wpisz komunikat dla graczy..." data-i18n-placeholder="messagePlaceholder"></textarea>

      <div class="preview" id="suffixPreview"></div>

      <div class="btnrow">
        <button class="primary" id="sendBtn" data-i18n="buttonSend">Wyślij</button>
        <button class="warn" id="pingBtn" data-i18n="buttonPing">Ping</button>
        <button id="clearBtn" data-i18n="buttonClearScreen">Wyczyść ekran</button>
        <button id="clearTextBtn" data-i18n="buttonClearField">Wyczyść pole</button>
      </div>

      <div class="small"><span data-i18n="labelStatus">Status:</span> <span class="status" id="status">…</span></div>
    </div>
  </div>

  <!-- ✅ Firebase config jako GLOBAL (window.firebaseConfig) -->
  <script src="config/firebase-config.js"></script>

  <!-- Firebase compat (działa w zwykłym <script>) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-firestore-compat.js"></script>

  <script>
    // --- Konfiguracja Firebase z config/firebase-config.js ---
    const firebaseConfig = window.firebaseConfig;
    if(!firebaseConfig){
      alert(translations[currentLanguage].messages.missingConfig);
      throw new Error("Missing window.firebaseConfig");
    }

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const currentRef = db.collection("dataslate").doc("current");

    const el = {
      faction: document.getElementById("faction"),

      // treść wiadomości
      fontColor: document.getElementById("fontColor"),
      msgFontSize: document.getElementById("msgFontSize"),

      // prefix/suffix styl
      psColorText: document.getElementById("psColorText"),
      psColorPicker: document.getElementById("psColorPicker"),
      psFontSize: document.getElementById("psFontSize"),

      // fillery
      randomFillers: document.getElementById("randomFillers"),
      prefixIndex: document.getElementById("prefixIndex"),
      suffixIndex: document.getElementById("suffixIndex"),
      showLogo: document.getElementById("showLogo"),
      flicker: document.getElementById("flicker"),

      // message
      message: document.getElementById("message"),

      // buttons
      sendBtn: document.getElementById("sendBtn"),
      clearBtn: document.getElementById("clearBtn"),
      clearTextBtn: document.getElementById("clearTextBtn"),
      pingBtn: document.getElementById("pingBtn"),

      // ui
      status: document.getElementById("status"),
      prefixPreview: document.getElementById("prefixPreview"),
      suffixPreview: document.getElementById("suffixPreview"),
      livePreview: document.getElementById("livePreview"),
      livePreviewPrefix: document.getElementById("livePreviewPrefix"),
      livePreviewMsg: document.getElementById("livePreviewMsg"),
      livePreviewSuffix: document.getElementById("livePreviewSuffix"),

      // chips
      chips: Array.from(document.querySelectorAll(".chip")),
    };

    const languageSelect = document.getElementById("languageSelect");

    const translations = {
      pl: {
        labels: {
          languageSelect: "Wersja językowa",
          pageTitle: "TEST: Infoczytnik - panel GM",
          labelFaction: "Frakcja / layout",
          labelMessageColor: "Kolor fontu (treść wiadomości)",
          colorGreen: "Zielony",
          colorRed: "Czerwony",
          colorGold: "Złoty",
          colorWhite: "Biały",
          labelMessageSize: "Wielkość fontu (treść wiadomości) — px",
          labelPrefixSuffixColor: "Kolor Prefix + Suffix (wspólny)",
          prefixSuffixColorHint: "Możesz wpisać np. <code>#ffffff</code> albo <code>rgba(255,255,255,.88)</code>",
          prefixSuffixPickerHint: "Picker ustawia kolor jako <code>#RRGGBB</code>",
          labelPrefixSuffixSize: "Wielkość fontu Prefix + Suffix (wspólna) — px",
          logoHint:
            "Logo ma stały rozmiar w Infoczytniku. Zmiana rozmiaru prefixu może spowodować zawijanie (OK), logo zostaje bez zmian.",
          labelFillersRandom: "Losowość fillerów",
          labelRandomAuto: "Losuj automatycznie",
          labelManual: "Ręcznie",
          labelPrefix: "Prefix",
          labelSuffix: "Suffix",
          randomHint: "Gdy losowanie wyłączone, wybierasz osobno numer Prefix i Suffix (1..N zależnie od frakcji).",
          labelShowLogo: "Dodaj logo",
          labelFlicker: "Flicker",
          labelMessage: "Treść komunikatu",
          messagePlaceholder: "Wpisz komunikat dla graczy...",
          buttonSend: "Wyślij",
          buttonPing: "Ping",
          buttonClearScreen: "Wyczyść ekran",
          buttonClearField: "Wyczyść pole",
          labelStatus: "Status:",
          factionMechanicus: "Adeptus Mechanicus",
          factionInquisition: "Inkwizycja",
          factionMilitarum: "Astra Militarum",
          factionKhorne: "Khorne",
          factionNurgle: "Nurgle",
          factionTzeentch: "Tzeentch",
          factionSlaanesh: "Slaanesh",
          factionChaosUndivided: "Chaos Undivided",
        },
        preview: {
          prefix: "++ NADCHODZĄCE DANE ++",
          message: "Lorem ipsum dolor sit amet, consectetur adipiscing elit.",
          suffix: "++ CHWAŁA OMNISSJASZOWI ++",
        },
        messages: {
          missingConfig: "Brak window.firebaseConfig. Sprawdź plik config/firebase-config.js",
          statusReady: "gotowe",
          statusSending: "wysyłam…",
          statusCleared: "wyczyszczono",
          statusSent: "wysłano",
          statusError: "BŁĄD",
          statusPingLoading: "ping…",
          statusPingSent: "ping wysłany",
          statusPingError: "BŁĄD ping",
          alertPingError: "Błąd ping:\n\n",
        },
      },
      en: {
        labels: {
          languageSelect: "Language version",
          pageTitle: "TEST: Data-Slate - GM panel",
          labelFaction: "Faction / layout",
          labelMessageColor: "Font color (message content)",
          colorGreen: "Green",
          colorRed: "Red",
          colorGold: "Gold",
          colorWhite: "White",
          labelMessageSize: "Font size (message content) — px",
          labelPrefixSuffixColor: "Prefix + Suffix color (shared)",
          prefixSuffixColorHint: "You can enter e.g. <code>#ffffff</code> or <code>rgba(255,255,255,.88)</code>",
          prefixSuffixPickerHint: "The picker sets color as <code>#RRGGBB</code>",
          labelPrefixSuffixSize: "Prefix + Suffix font size (shared) — px",
          logoHint:
            "The logo size is fixed in Data-Slate. Changing the prefix size may wrap (OK), the logo remains unchanged.",
          labelFillersRandom: "Filler randomness",
          labelRandomAuto: "Auto randomize",
          labelManual: "Manual",
          labelPrefix: "Prefix",
          labelSuffix: "Suffix",
          randomHint: "When randomization is off, you choose Prefix and Suffix numbers (1..N depending on faction).",
          labelShowLogo: "Add logo",
          labelFlicker: "Flicker",
          labelMessage: "Message content",
          messagePlaceholder: "Type a message for players...",
          buttonSend: "Send",
          buttonPing: "Ping",
          buttonClearScreen: "Clear screen",
          buttonClearField: "Clear field",
          labelStatus: "Status:",
          factionMechanicus: "Adeptus Mechanicus",
          factionInquisition: "Inquisition",
          factionMilitarum: "Astra Militarum",
          factionKhorne: "Khorne",
          factionNurgle: "Nurgle",
          factionTzeentch: "Tzeentch",
          factionSlaanesh: "Slaanesh",
          factionChaosUndivided: "Chaos Undivided",
        },
        preview: {
          prefix: "++ INCOMING DATA FEED ++",
          message: "Lorem ipsum dolor sit amet, consectetur adipiscing elit.",
          suffix: "++ PRAISE THE OMNISSIAH ++",
        },
        messages: {
          missingConfig: "Missing window.firebaseConfig. Check config/firebase-config.js.",
          statusReady: "ready",
          statusSending: "sending…",
          statusCleared: "cleared",
          statusSent: "sent",
          statusError: "ERROR",
          statusPingLoading: "ping…",
          statusPingSent: "ping sent",
          statusPingError: "ping error",
          alertPingError: "Ping error:\n\n",
        },
      },
    };

    let currentLanguage = "pl";

    const applyLanguage = (lang) => {
      currentLanguage = lang;
      const t = translations[lang];
      document.documentElement.lang = lang;
      if (languageSelect) {
        languageSelect.value = lang;
        languageSelect.setAttribute("aria-label", t.labels.languageSelect);
      }
      document.title = t.labels.pageTitle;
      document.querySelectorAll("[data-i18n]").forEach((element) => {
        const key = element.getAttribute("data-i18n");
        if (key in t.labels) {
          element.textContent = t.labels[key];
        }
      });
      document.querySelectorAll("[data-i18n-placeholder]").forEach((element) => {
        const key = element.getAttribute("data-i18n-placeholder");
        if (key in t.labels) {
          element.setAttribute("placeholder", t.labels[key]);
        }
      });
      document.querySelectorAll("[data-i18n]").forEach((element) => {
        if (["prefixSuffixColorHint", "prefixSuffixPickerHint", "logoHint"].includes(element.getAttribute("data-i18n"))) {
          element.innerHTML = t.labels[element.getAttribute("data-i18n")];
        }
      });
      el.livePreviewMsg.textContent = t.preview.message;
      if (el.status?.dataset?.statusKey && t.messages[el.status.dataset.statusKey]) {
        el.status.textContent = t.messages[el.status.dataset.statusKey];
      }
      computePreview();
    };

    const FONT_STACK = {
      mechanicus:      '"Share Tech Mono", Calibri, Arial, sans-serif',
      inquisition:     '"Cinzel", Calibri, Arial, sans-serif',
      militarum:       '"Rajdhani", Calibri, Arial, sans-serif',
      khorne:          '"Black Ops One", Calibri, Arial, sans-serif',
      nurgle:          '"Staatliches", Calibri, Arial, sans-serif',
      tzeentch:        '"Orbitron", Calibri, Arial, sans-serif',
      slaanesh:        '"Questrial", Calibri, Arial, sans-serif',
      chaos_undivided: '"Russo One", Calibri, Arial, sans-serif',
    };

    const LAYOUTS = {
      mechanicus:{prefixes:["++ INCOMING DATA FEED ++","++ SYSTEM ANALYSIS BEGIN ++","++ ENCRYPTION ONLINE ++","++ ENGAGE LITURGY ++","++ ARCHIVE ACCESS ++","++ LOGIS-CHANNEL ACTIVE ++","++ DATA LINK ESTABLISHED ++","++ SIGNAL LOCKED ++","++ CORE STABILIZED ++"],
                 suffixes:["++ PRAISE THE OMNISSIAH ++","++ MACHINE SPIRIT CALMED ++","++ THE FLESH IS WEAK ++","++ SYSTEM CLEANSED ++","++ BINARY PRAYER SENT ++","++ OMNISSIAH GUIDE US ++","++ SERVITOR READY ++","++ RITUAL COMPLETE ++","++ PRAY TO THE CODE ++"]},
      inquisition:{prefixes:["++ INQUISITORIAL NOTICE ++","++ DATA INTERCEPTED ++","++ DECRYPTING ORDER ++","++ ORDER: SIGMA-9 ++","++ COGITATOR ACCESS ++","++ BY HIS WILL ++","++ CLASSIFIED MATERIAL ++","++ MIND CLEANSED ++","++ CODEX SECURED ++"],
                  suffixes:["++ THE EMPEROR PROTECTS ++","++ AUTHORIZATION VERIFIED ++","++ PURGE COMPLETE ++","++ FAITH REMAINS ++","++ THOUGHT FOR THE DAY ++","++ HERESY PURGED ++","++ OATH UPHELD ++","++ FAITH IS ARMOR ++","++ EXAMINATION COMPLETE ++"]},
      militarum:{prefixes:["++ IMPERIAL SIGNAL ++","++ HIGH COMMAND ORDER ++","++ ORDERS INCOMING ++","++ TACTICAL FEED ++","++ REGIMENTAL DATA ++","++ COMMAND OVERRIDE ++","++ BATTLELINE UPLINK ++","++ ENGAGEMENT ACTIVE ++","++ OPERATIONAL BRIEF ++"],
                 suffixes:["++ GLORY TO THE GUARD ++","++ VICTORY IS ASSURED ++","++ CADIA STANDS ++","++ DUTY FULFILLED ++","++ NO SACRIFICE TOO GREAT ++","++ PERIMETER SECURED ++","++ FOR THE EMPEROR ++","++ STATUS: GREEN ++","++ STRATEGIC DIRECTIVE ++"]},
      khorne:{prefixes:["++ BLOOD ALERT ++","++ SKULL COUNT RISING ++","++ RAGE TRANSMISSION ++","++ COMBAT UPLINK ++","++ SLAUGHTER INITIATED ++","++ VIOLENCE MAXIMUM ++","++ NO PEACE ONLY WAR ++","++ RIP THEIR HEADS ++","++ DOMINATE THROUGH BLOOD ++"],
              suffixes:["++ BLOOD FOR THE BLOOD GOD ++","++ SKULLS FOR THE THRONE ++","++ RIP AND TEAR ++","++ ALL MUST BLEED ++","++ DEATH WITHOUT END ++","++ STRIKE WITHOUT MERCY ++","++ AXE ONLINE ++","++ RED FLOWS ++","++ KILL. MAIM. BURN. ++"]},
      nurgle:{prefixes:["++ BLOAT SIGNAL ++","++ DECAY INITIATED ++","++ DISEASE VECTOR ACTIVE ++","++ PLAGUE SEED SENT ++","++ SPOREFIELD DEPLOYED ++","++ VIRUSCODE ENGAGED ++","++ ALL IS ROT ++","++ FLESH SAGS ++","++ FOULNESS RISES ++"],
              suffixes:["++ PRAISE GRANDPA NURGLE ++","++ FILTH TRANSMITTED ++","++ ROTTEN JOY ++","++ CONTAGION SPREADS ++","++ FLIES REJOICE ++","++ FESTERING COMPLETE ++","++ MUCOUS FLOW ++","++ BLESSINGS OF ROT ++","++ CORRUPTION GLORIOUS ++"]},
      tzeentch:{prefixes:["++ KNOWLEDGE UNFOLDS ++","++ SCHEME RUNNING ++","++ DATA TWISTED ++","++ WARP-TEXT INCOMING ++","++ INVERSION ACTIVE ++","++ DESTINY WRITTEN ++","++ NOTHING IS AS IT SEEMS ++","++ PATTERNS SHIFT ++","++ BURN THE SCRIPT ++"],
               suffixes:["++ ALL IS CHANGE ++","++ PLAN: PHASE 7 ++","++ EYE OPENS ++","++ BIRD OF FATE SMILES ++","++ THOUGHT MUTATED ++","++ CYCLE CONTINUES ++","++ OBSERVE THE CHANGE ++","++ REWRITE EVERYTHING ++","++ JUST AS PLANNED ++"]},
      slaanesh:{prefixes:["++ ECSTASY PULSE ++","++ SENSORY OVERLOAD ++","++ LUXURY CHANNEL OPEN ++","++ VELVET SIGNAL ++","++ DESIRE BREACH ++","++ TOUCH THE DIVINE ++","++ TASTE THE PAIN ++","++ LUSTWAVE TRANSMITTED ++","++ EXCESS COMPLETE ++"],
               suffixes:["++ FEED THE HUNGER ++","++ THE PERFECT MOMENT ++","++ PAIN IS PLEASURE ++","++ EXCESS IS TRUTH ++","++ PLEASURE SATURATED ++","++ UNHOLY HARMONY ++","++ FEEL EVERYTHING ++","++ TEMPTATION SPIKE ++","++ PERFECTION IS BLISS ++"]},
      chaos_undivided:{prefixes:["++ WARP STIRRING ++","++ TRANSMISSION CORRUPTED ++","++ HERESY INBOUND ++","++ WARP SIGNATURE FOUND ++","++ SACRIFICE ACCEPTED ++","++ WARP ENERGY RISING ++","++ ORDER BREAKS ++","++ FLESH TURNS ++","++ ASCENSION IMMINENT ++"],
                      suffixes:["++ GLORY TO CHAOS ++","++ DARK GODS SMILE ++","++ THE EYE OPENS ++","++ ASCEND AND BURN ++","++ ALL HAIL THE DARK GODS ++","++ REALSPACE BLEEDS ++","++ STARS ARE WRONG ++","++ VOID WITHIN ++","++ ETERNAL CHANGE ++"]},
    };

    function setStatus(t, key){
      el.status.textContent = t;
      if (key) {
        el.status.dataset.statusKey = key;
      }
    }
    function clampIndex(n, max){ const x=Number(n); if(!Number.isFinite(x)) return 1; return Math.min(max, Math.max(1, Math.floor(x))); }
    function rand1to(max){ return Math.floor(Math.random()*max)+1; }
    function nonce(){ return String(Date.now()) + "-" + String(Math.random()).slice(2); }
    function getLayout(){ return LAYOUTS[el.faction.value] || LAYOUTS.mechanicus; }

    function normalizePx(n, min, max, fallback){
      const x = Number(n);
      if(!Number.isFinite(x)) return fallback;
      return Math.max(min, Math.min(max, Math.floor(x)));
    }

    function getPrefixSuffixColor(){
      const t = (el.psColorText.value || "").trim();
      return t || "rgba(255,255,255,.88)";
    }

    function updateLivePreview(){
      const fontStack = FONT_STACK[el.faction.value] || 'Calibri, Arial, sans-serif';
      const msgFontPx = normalizePx(el.msgFontSize.value, 12, 80, 20) + "px";
      const psFontPx  = normalizePx(el.psFontSize.value, 10, 60, 10) + "px";
      const psColor   = getPrefixSuffixColor();
      const msgColor  = el.fontColor.value || "#00ff66";

      el.livePreview.style.fontFamily = fontStack;
      el.livePreviewPrefix.textContent = el.prefixPreview.textContent || "";
      el.livePreviewSuffix.textContent = el.suffixPreview.textContent || "";

      el.livePreviewPrefix.style.color = psColor;
      el.livePreviewSuffix.style.color = psColor;
      el.livePreviewPrefix.style.fontSize = psFontPx;
      el.livePreviewSuffix.style.fontSize = psFontPx;

      el.livePreviewMsg.style.color = msgColor;
      el.livePreviewMsg.style.fontSize = msgFontPx;
    }

    function computePreview(){
      const cfg=getLayout();
      const pMax=cfg.prefixes.length, sMax=cfg.suffixes.length;

      el.prefixIndex.max = String(pMax);
      el.suffixIndex.max = String(sMax);

      const pIdx=el.randomFillers.checked ? rand1to(pMax) : clampIndex(el.prefixIndex.value, pMax);
      const sIdx=el.randomFillers.checked ? rand1to(sMax) : clampIndex(el.suffixIndex.value, sMax);

      if(!el.randomFillers.checked){
        el.prefixIndex.value = pIdx;
        el.suffixIndex.value = sIdx;
      }

      el.prefixPreview.textContent = cfg.prefixes[pIdx-1] || "";
      el.suffixPreview.textContent = cfg.suffixes[sIdx-1] || "";

      // blokuj ręczne pola gdy losuje
      const manualDisabled = el.randomFillers.checked;
      el.prefixIndex.disabled = manualDisabled;
      el.suffixIndex.disabled = manualDisabled;

      updateLivePreview();
    }

    async function sendMessage(isClear){
      const cfg=getLayout();
      const pMax=cfg.prefixes.length, sMax=cfg.suffixes.length;

      const prefixIndex=el.randomFillers.checked ? rand1to(pMax) : clampIndex(el.prefixIndex.value, pMax);
      const suffixIndex=el.randomFillers.checked ? rand1to(sMax) : clampIndex(el.suffixIndex.value, sMax);

      const msgFontPx = normalizePx(el.msgFontSize.value, 12, 80, 20);
      const psFontPx  = normalizePx(el.psFontSize.value, 10, 60, 10);

      setStatus(translations[currentLanguage].messages.statusSending, "statusSending");
      try{
        await currentRef.set({
          type: isClear ? "clear" : "message",
          faction: el.faction.value,

          // treść wiadomości
          color: el.fontColor.value || "#00ff66",
          fontColor: el.fontColor.value || "#00ff66",
          msgFontSize: msgFontPx + "px",

          // prefix/suffix styl
          prefixColor: getPrefixSuffixColor(),
          suffixColor: getPrefixSuffixColor(),
          prefixFontSize: psFontPx + "px",
          suffixFontSize: psFontPx + "px",

          // fillery
          prefixIndex, suffixIndex,
          showLogo: !!el.showLogo.checked,
          flicker: !!el.flicker.checked,

          // tekst
          text: isClear ? "" : (el.message.value || ""),

          nonce: nonce(),
          ts: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:false });

        setStatus(
          isClear
            ? translations[currentLanguage].messages.statusCleared
            : translations[currentLanguage].messages.statusSent,
          isClear ? "statusCleared" : "statusSent"
        );
      }catch(e){
        console.error(e);
        setStatus(translations[currentLanguage].messages.statusError, "statusError");
        alert("Błąd zapisu:\n\n" + (e?.message || e));
      }
      computePreview();
    }

    async function ping(){
      const msgFontPx = normalizePx(el.msgFontSize.value, 12, 80, 20);
      const psFontPx  = normalizePx(el.psFontSize.value, 10, 60, 10);

      setStatus(translations[currentLanguage].messages.statusPingLoading, "statusPingLoading");
      try{
        await currentRef.set({
          type:"ping",
          faction: el.faction.value,

          // zostawiamy styl w docu, żeby nie “gubić” ustawień
          color: el.fontColor.value || "#00ff66",
          fontColor: el.fontColor.value || "#00ff66",
          msgFontSize: msgFontPx + "px",
          prefixColor: getPrefixSuffixColor(),
          suffixColor: getPrefixSuffixColor(),
          prefixFontSize: psFontPx + "px",
          suffixFontSize: psFontPx + "px",
          showLogo: !!el.showLogo.checked,
          flicker: !!el.flicker.checked,

          nonce: nonce(),
          ts: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });

        setStatus(translations[currentLanguage].messages.statusPingSent, "statusPingSent");
      }catch(e){
        console.error(e);
        setStatus(translations[currentLanguage].messages.statusPingError, "statusPingError");
        alert(translations[currentLanguage].messages.alertPingError + (e?.message || e));
      }
    }

    // ====== EVENTY ======
    el.sendBtn.addEventListener("click", () => sendMessage(false));
    el.clearBtn.addEventListener("click", () => sendMessage(true));
    el.pingBtn.addEventListener("click", ping);

    el.clearTextBtn.addEventListener("click", () => {
      el.message.value = "";
      el.message.focus();
    });

    // chips (msg i ps)
    el.chips.forEach(ch => ch.addEventListener("click", () => {
      const target = ch.getAttribute("data-target");
      const c = ch.getAttribute("data-color");
      if(!c) return;

      if(target === "msg"){
        el.fontColor.value = c;
      }else if(target === "ps"){
        el.psColorText.value = c;
        if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(c)){
          el.psColorPicker.value = (c.length===4)
            ? ("#" + c[1]+c[1]+c[2]+c[2]+c[3]+c[3])
            : c;
        }
      }

      updateLivePreview();
    }));

    // picker prefix/suffix -> ustawia tekst na #RRGGBB
    el.psColorPicker.addEventListener("input", () => {
      el.psColorText.value = el.psColorPicker.value;
      updateLivePreview();
    });

    ["change","input"].forEach(evt=>{
      el.faction.addEventListener(evt, computePreview);
      el.randomFillers.addEventListener(evt, computePreview);
      el.prefixIndex.addEventListener(evt, computePreview);
      el.suffixIndex.addEventListener(evt, computePreview);
    });

    ["input","change"].forEach(evt=>{
      el.fontColor.addEventListener(evt, updateLivePreview);
      el.msgFontSize.addEventListener(evt, updateLivePreview);
      el.psColorText.addEventListener(evt, updateLivePreview);
      el.psFontSize.addEventListener(evt, updateLivePreview);
    });

    applyLanguage(currentLanguage);
    if (languageSelect) {
      languageSelect.addEventListener("change", (event) => {
        applyLanguage(event.target.value);
      });
    }

    setStatus(translations[currentLanguage].messages.statusReady, "statusReady");
    computePreview();
  </script>
</body>
</html>
